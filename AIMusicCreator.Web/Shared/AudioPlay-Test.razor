
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="mb-3 p-3 border rounded bg-primary bg-opacity-10">
    <h6>ğŸ“ æœ¬åœ°æ–‡ä»¶æ’­æ”¾: @localFileName</h6>
    <audio @ref="audioElement"
           controls
           style="width: 100%"
           src="@localAudioUrl"
           oncanplay="@OnLocalAudioCanPlay"
           onloadedmetadata="@OnLocalAudioMetadataLoaded"
           // ç§»é™¤ä¸å­˜åœ¨çš„äº‹ä»¶å¤„ç†å™¨
           onerror="@OnLocalAudioError"
           onstalled="@OnLocalAudioStalled"
           onsuspend="@OnLocalAudioSuspend">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>
    <div class="mt-2">
        <small class="text-success">âœ“ æœ¬åœ°æ–‡ä»¶å·²åŠ è½½</small>
        @if (audioDuration > 0)
        {
            <span class="badge bg-info ms-2">æ—¶é•¿: @TimeSpan.FromSeconds(audioDuration).ToString(@"mm\:ss")</span>
        }
        <span class="badge bg-secondary ms-2">å¤§å°: @GetFileSize(FileSize)</span>
        <button @onclick="ClearLocalAudio" class="btn btn-sm btn-outline-secondary ms-2">å…³é—­</button>
    </div>
    <div class="mt-1">
        <small class="text-muted">éŸ³é¢‘çŠ¶æ€: @audioStatus</small>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>é”™è¯¯:</strong> @errorMessage
        <button @onclick="ClearError" class="btn btn-sm btn-outline-danger float-end">Ã—</button>
    </div>
}
@if (!string.IsNullOrEmpty(localAudioUrl))
{
    <div class="mt-2">
        <button @onclick="CheckAudioState" class="btn btn-sm btn-outline-info">æ£€æŸ¥éŸ³é¢‘çŠ¶æ€</button>
        <button @onclick="ReloadAudio" class="btn btn-sm btn-outline-warning ms-1">é‡æ–°åŠ è½½</button>
    </div>
}
@if (!string.IsNullOrEmpty(debugInfo))
{
    <div class="mt-3 p-2 border rounded bg-light">
        <small class="text-muted">è°ƒè¯•ä¿¡æ¯: @debugInfo</small>
    </div>
}
@code {
    /// <summary>
    /// éŸ³é¢‘å…ƒç´ å¼•ç”¨
    /// </summary>
    private ElementReference audioElement;
    /// <summary>
    /// æœ¬åœ°éŸ³é¢‘URL
    /// </summary>
    private string? localAudioUrl { get; set; }
    /// <summary>
    /// æœ¬åœ°æ–‡ä»¶å
    /// </summary>
    [Parameter] public string? localFileName { get; set; }
    /// <summary>
    /// æ–‡ä»¶å¤§å°
    /// </summary>
    private long FileSize { get; set; } = 0L;
    /// <summary>
    /// é”™è¯¯æ¶ˆæ¯
    /// </summary>
    private string? errorMessage;
    /// <summary>
    /// è°ƒè¯•ä¿¡æ¯
    /// </summary>
    private string? debugInfo;
    /// <summary>
    /// éŸ³é¢‘æ—¶é•¿
    /// </summary>
    private double audioDuration = 0;
    /// <summary>
    /// é€‰ä¸­çš„æ–‡ä»¶
    /// </summary>
    [Parameter] public IBrowserFile? SelectedFile { get; set; }
    /// <summary>
    /// æ–‡ä»¶å†…å®¹
    /// </summary>
    [Parameter] public byte[] FileContent { get; set; } = [];
    /// <summary>
    /// å†…å®¹ç±»å‹
    /// </summary>
    [Parameter] public string ContentType { get; set; } = string.Empty;
    /// <summary>
    /// éŸ³é¢‘çŠ¶æ€
    /// </summary>
    private string audioStatus = "æœªåŠ è½½";
    /// <summary>
    /// è·å–éŸ³é¢‘å…ƒç´ å¼•ç”¨
    /// </summary>
    public ElementReference AudioElementRef => audioElement;

    /// <summary>
    /// ç»„ä»¶æ¸²æŸ“åå¼‚æ­¥åŠ è½½JavaScriptåŠ©æ‰‹å‡½æ•°
    /// </summary>
    /// <param name="firstRender">æ˜¯å¦é¦–æ¬¡æ¸²æŸ“</param>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadJavaScriptHelpers();
        }
    }
    /// <summary>
    /// ç»„ä»¶å‚æ•°è®¾ç½®åå¼‚æ­¥æ’­æ”¾æœ¬åœ°æ–‡ä»¶
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    protected override async Task OnParametersSetAsync()
    {
        await PlayLocalFile();
        await base.OnParametersSetAsync();
    }
    // PlayLocalFileæ–¹æ³•å·²åœ¨æ–‡ä»¶åé¢é‡æ–°å®ç°ï¼ŒåŠŸèƒ½æ›´å®Œå–„
    /// <summary>
    /// å¼‚æ­¥åŠ è½½JavaScriptåŠ©æ‰‹å‡½æ•°
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task LoadJavaScriptHelpers()
    {
        try
        {
            // æ£€æŸ¥JavaScriptå‡½æ•°æ˜¯å¦å·²åŠ è½½
            var isLoaded = await JSRuntime.InvokeAsync<bool>("eval", "typeof createAudioObjectURL !== 'undefined'");
            if (!isLoaded)
            {
                debugInfo = "JavaScriptåŠ©æ‰‹å‡½æ•°æœªåŠ è½½ï¼Œè¯·ç¡®ä¿audioHelper.jså·²å¼•å…¥";
            }
            else
            {
                debugInfo = "JavaScriptåŠ©æ‰‹å‡½æ•°å·²å°±ç»ª";
            }
        }
        catch (Exception ex)
        {
            debugInfo = $"JavaScriptåŠ è½½æ£€æŸ¥å¤±è´¥: {ex.Message}";
        }
        StateHasChanged();
    }
    /// <summary>
    /// å¼‚æ­¥ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆ
    /// </summary>
    /// <param name="audioElement">éŸ³é¢‘å…ƒç´ å¼•ç”¨</param>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task WaitForAudioLoad(ElementReference audioElement)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("waitForAudioLoad", audioElement);
            audioStatus = "åŠ è½½å®Œæˆ";
            debugInfo = "éŸ³é¢‘åŠ è½½å®Œæˆ";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            audioStatus = "åŠ è½½é”™è¯¯";
            debugInfo = $"éŸ³é¢‘åŠ è½½å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }
    /// <summary>
    /// å¼‚æ­¥ç­‰å¾…éŸ³é¢‘å‡†å¤‡å°±ç»ª
    /// </summary>
    /// <param name="audioElement">éŸ³é¢‘å…ƒç´ å¼•ç”¨</param>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task WaitForAudioReady(ElementReference audioElement)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("waitForAudioReady", audioElement);
            audioStatus = "å°±ç»ª";
            debugInfo = "éŸ³é¢‘å°±ç»ª";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            audioStatus = "å°±ç»ªé”™è¯¯";
            debugInfo = $"éŸ³é¢‘å°±ç»ªå¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }
    /// <summary>
    /// æ¸…é™¤é”™è¯¯ä¿¡æ¯
    /// </summary>
    private void ClearError()
    {
        errorMessage = null;
        StateHasChanged();
    }
    /// <summary>
    /// å¼‚æ­¥å°è¯•è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task TryAutoPlay()
    {
        try
        {
            // å°è¯•æ’­æ”¾ï¼ˆå¯èƒ½éœ€è¦ç”¨æˆ·é¦–æ¬¡äº¤äº’ï¼‰
            await JSRuntime.InvokeVoidAsync("tryPlayAudio", audioElement);
        }
        catch (Exception)
        {
            // è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢æ˜¯æ­£å¸¸çš„ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’
            debugInfo = "è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®";
        }
    }
    /// <summary>
    /// å¼‚æ­¥å¤„ç†éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆäº‹ä»¶
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task OnLocalAudioMetadataLoaded()
    {
        try
        {
            audioDuration = await JSRuntime.InvokeAsync<double>("getAudioDuration", audioElement);
            audioStatus = $"å…ƒæ•°æ®åŠ è½½å®Œæˆ ({audioDuration:F2}ç§’)";
            debugInfo = $"éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œæ—¶é•¿: {audioDuration}ç§’";
            StateHasChanged();

            // å°è¯•è‡ªåŠ¨æ’­æ”¾ï¼ˆå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
            await TryAutoPlay();
        }
        catch (Exception ex)
        {
            audioStatus = "å…ƒæ•°æ®åŠ è½½é”™è¯¯";
            debugInfo = $"å…ƒæ•°æ®åŠ è½½å›è°ƒå¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }
    /// <summary>
    /// å¼‚æ­¥å¤„ç†éŸ³é¢‘å¯ä»¥æ’­æ”¾äº‹ä»¶
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task OnLocalAudioCanPlay()
    {
        try
        {
            await Task.CompletedTask;
            audioStatus = "å¯ä»¥æ’­æ”¾";
            debugInfo = "éŸ³é¢‘å¯ä»¥æ’­æ”¾";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            audioStatus = "å¯ä»¥æ’­æ”¾ä½†å‘ç”Ÿé”™è¯¯";
            debugInfo = $"å¯ä»¥æ’­æ”¾å›è°ƒå¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }
    /// <summary>
    /// å¼‚æ­¥å¤„ç†éŸ³é¢‘ç¼“å†²ä¸­äº‹ä»¶
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private void OnLocalAudioStalled()
    {
        audioStatus = "ç¼“å†²ä¸­...";
        debugInfo = "éŸ³é¢‘ç¼“å†²ä¸­";
        StateHasChanged();
    }
    /// <summary>
    /// å¼‚æ­¥å¤„ç†éŸ³é¢‘åŠ è½½æš‚åœäº‹ä»¶
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private void OnLocalAudioSuspend()
    {
        audioStatus = "åŠ è½½æš‚åœ";
        debugInfo = "éŸ³é¢‘åŠ è½½æš‚åœ";
        StateHasChanged();
    }
    /// <summary>
    /// å¼‚æ­¥å¤„ç†éŸ³é¢‘é”™è¯¯äº‹ä»¶
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task OnLocalAudioError()
    {
        try
        {
            var errorInfo = await JSRuntime.InvokeAsync<string>("getAudioError", audioElement);
            audioStatus = $"é”™è¯¯: {errorInfo}";
            errorMessage = $"éŸ³é¢‘æ’­æ”¾é”™è¯¯: {errorInfo}";
            debugInfo = $"éŸ³é¢‘é”™è¯¯: {errorInfo}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            audioStatus = "æœªçŸ¥é”™è¯¯";
            errorMessage = $"éŸ³é¢‘æ’­æ”¾å‘ç”Ÿé”™è¯¯";
            debugInfo = $"é”™è¯¯å¤„ç†å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }
    /// <summary>
    /// è·å–æ–‡ä»¶å¤§å°çš„å¯è¯»å­—ç¬¦ä¸²
    /// </summary>
    /// <param name="bytes">æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰</param>
    /// <returns>å¯è¯»çš„æ–‡ä»¶å¤§å°å­—ç¬¦ä¸²ï¼ˆå¦‚ï¼š1.23 MBï¼‰</returns>
    private string GetFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double len = bytes;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
    /// <summary>
    /// æ’­æ”¾æœ¬åœ°éŸ³é¢‘æ–‡ä»¶
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task PlayLocalFile()
    {
        if (SelectedFile == null && FileContent.Length == 0) return;
        if (SelectedFile != null)
        {
            try
            {
                errorMessage = null;
                localAudioUrl = null;
                audioDuration = 0;
                FileSize = 0;
                StateHasChanged();

                // è®©UIæœ‰æ—¶é—´æ›´æ–°çŠ¶æ€

                debugInfo = $"å¼€å§‹å¤„ç†æ–‡ä»¶: {SelectedFile.Name}";
                StateHasChanged();

                // åˆ›å»ºå¯¹è±¡URL
                var url = await CreateDirectObjectUrl(SelectedFile);

                if (!string.IsNullOrEmpty(url))
                {
                    debugInfo = "å¯¹è±¡URLåˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨è®¾ç½®éŸ³é¢‘æº...";
                    StateHasChanged();

                    // ç›´æ¥è®¾ç½®localAudioUrlï¼Œè®©Blazorå¤„ç†éŸ³é¢‘å…ƒç´ 
                    localAudioUrl = url;
                    localFileName = SelectedFile.Name;
                    FileSize = SelectedFile.Size;
                    // é€šçŸ¥UIæ›´æ–°
            StateHasChanged();

                    // ç°åœ¨æ£€æŸ¥éŸ³é¢‘å…ƒç´ çš„çŠ¶æ€
                    var duration = await JSRuntime.InvokeAsync<double>("getAudioDuration", audioElement);
                    if (duration > 0)
                    {
                        audioDuration = duration;
                        debugInfo = $"éŸ³é¢‘åŠ è½½æˆåŠŸï¼Œæ—¶é•¿: {duration}ç§’";
                    }
                    else
                    {
                        debugInfo = "éŸ³é¢‘å…ƒç´ å·²è®¾ç½®ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’...";
                    }
                }
                else
                {
                    errorMessage = "æ— æ³•åˆ›å»ºéŸ³é¢‘URLï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶ã€‚";
                    debugInfo = "å¯¹è±¡URLåˆ›å»ºå¤±è´¥";
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"æ’­æ”¾å¤±è´¥: {ex.Message}";
                debugInfo = $"å¼‚å¸¸: {ex.Message}";
            }
            finally
            {
                // isLoading = false;
                StateHasChanged();
            }
        }
        else if (FileContent != null && FileContent.Length > 0)
        {
            try
            {
                errorMessage = null;
                localAudioUrl = null;
                audioDuration = 0;
                FileSize = 0;
                StateHasChanged();

                // ç»™UIæ—¶é—´æ›´æ–°åŠ è½½çŠ¶æ€
                await Task.Delay(10);

                debugInfo = $"å¼€å§‹å¤„ç†æ–‡ä»¶:";
                StateHasChanged();

                // åˆ›å»ºå¯¹è±¡URL
                var url = await CreateDirectObjectUrl(FileContent, ContentType);

                if (!string.IsNullOrEmpty(url))
                {
                    debugInfo = "å¯¹è±¡URLåˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨è®¾ç½®éŸ³é¢‘æº...";
                    StateHasChanged();

                    // ç›´æ¥è®¾ç½®localAudioUrlï¼Œè®©Blazorå¤„ç†éŸ³é¢‘å…ƒç´ 
                    localAudioUrl = url;
                    // localFileName = SelectedFile.Name;
                    FileSize = FileContent.LongLength;
                    // ç­‰å¾…ä¸‹ä¸€æ¬¡æ¸²æŸ“å®Œæˆ
                    StateHasChanged();
                    await Task.Delay(100);

                    // ç°åœ¨æ£€æŸ¥éŸ³é¢‘å…ƒç´ çš„çŠ¶æ€
                    var duration = await JSRuntime.InvokeAsync<double>("getAudioDuration", audioElement);
                    if (duration > 0)
                    {
                        audioDuration = duration;
                        debugInfo = $"éŸ³é¢‘åŠ è½½æˆåŠŸï¼Œæ—¶é•¿: {duration}ç§’";
                    }
                    else
                    {
                        debugInfo = "éŸ³é¢‘å…ƒç´ å·²è®¾ç½®ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’...";
                    }
                }
                else
                {
                    errorMessage = "æ— æ³•åˆ›å»ºéŸ³é¢‘URLï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶ã€‚";
                    debugInfo = "å¯¹è±¡URLåˆ›å»ºå¤±è´¥";
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"æ’­æ”¾å¤±è´¥: {ex.Message}";
                debugInfo = $"å¼‚å¸¸: {ex.Message}";
            }
            finally
            {
                // isLoading = false;
                StateHasChanged();
            }
        }
    }
    /// <summary>
    /// å¼‚æ­¥åˆ›å»ºç›´æ¥å¯¹è±¡URL
    /// </summary>
    /// <param name="audioFileContent">éŸ³é¢‘æ–‡ä»¶å†…å®¹</param>
    /// <param name="contentType">éŸ³é¢‘æ–‡ä»¶ç±»å‹</param>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›ç›´æ¥å¯¹è±¡URL</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task<string?> CreateDirectObjectUrl(byte[] audioFileContent, string contentType)
    {
        try
        {
            using var fileStream = new ByteArrayContent(audioFileContent);
            var streamRef = new DotNetStreamReference(fileStream.ReadAsStream());

            // è°ƒç”¨JavaScriptå‡½æ•°åˆ›å»ºå¯¹è±¡URL
            return await JSRuntime.InvokeAsync<string>("createAudioObjectURL", streamRef, ContentType);
        }
        catch (Exception ex)
        {
            debugInfo = $"ç›´æ¥å¯¹è±¡URLåˆ›å»ºå¤±è´¥: {ex.Message}";
            return await CreateAlternativeUrl(audioFileContent, ContentType);
        }
    }
    /// <summary>
    /// å¼‚æ­¥åˆ›å»ºç›´æ¥å¯¹è±¡URL
    /// </summary>
    /// <param name="file">æµè§ˆå™¨æ–‡ä»¶å¯¹è±¡</param>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›ç›´æ¥å¯¹è±¡URL</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task<string?> CreateDirectObjectUrl(IBrowserFile file)
    {
        try
        {
            var maxAllowedSize = Math.Max( 10 * 1024 * 1024,file.Size); // 10MB
            debugInfo = $"åˆ›å»ºå¯¹è±¡URL: {file.Name} ({GetFileSize(file.Size)})";
            StateHasChanged();

            using var fileStream = file.OpenReadStream(maxAllowedSize);
            var streamRef = new DotNetStreamReference(fileStream);

            // è°ƒç”¨JavaScriptå‡½æ•°åˆ›å»ºå¯¹è±¡URL
            return await JSRuntime.InvokeAsync<string>("createAudioObjectURL", streamRef, file.ContentType);
        }
        catch (Exception ex)
        {
            debugInfo = $"ç›´æ¥å¯¹è±¡URLåˆ›å»ºå¤±è´¥: {ex.Message}";
            return await CreateAlternativeUrl(file);
        }
    }
    /// <summary>
    /// å¼‚æ­¥åˆ›å»ºå¤‡ç”¨URLï¼ˆBase64ç¼–ç ï¼‰
    /// </summary>
    /// <param name="audioFileContent">éŸ³é¢‘æ–‡ä»¶å†…å®¹</param>
    /// <param name="contentType">éŸ³é¢‘æ–‡ä»¶ç±»å‹</param>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›å¤‡ç”¨URL</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task<string?> CreateAlternativeUrl(byte[] audioFileContent, string contentType)
    {
        await Task.CompletedTask;
        try
        {
            debugInfo = "å°è¯•å¤‡ç”¨æ–¹æ¡ˆ (Base64)...";
            StateHasChanged();

            const int maxAllowedSize = 5 * 1024 * 1024; // 5MB
            if (audioFileContent.Length > maxAllowedSize)
            {
                debugInfo = $"æ–‡ä»¶è¿‡å¤§: {GetFileSize(audioFileContent.LongLength)}";
                return null;
            }

            var base64String = Convert.ToBase64String(audioFileContent);
            var dataUrl = $"data:{contentType};base64,{base64String}";

            debugInfo = "Base64 URLåˆ›å»ºæˆåŠŸ";
            return dataUrl;
        }
        catch (Exception ex)
        {
            debugInfo = $"å¤‡ç”¨æ–¹æ¡ˆå¤±è´¥: {ex.Message}";
            return null;
        }
    }
    /// <summary>
    /// å¼‚æ­¥åˆ›å»ºå¤‡ç”¨URLï¼ˆBase64ç¼–ç ï¼‰
    /// </summary>
    /// <param name="file">æµè§ˆå™¨æ–‡ä»¶å¯¹è±¡</param>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›å¤‡ç”¨URL</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task<string?> CreateAlternativeUrl(IBrowserFile file)
    {
        const int maxAllowedSize = 5 * 1024 * 1024; // 5MB
        const int bufferSize = 81920; // 80KB

        try
        {
            debugInfo = "å°è¯•å¤‡ç”¨æ–¹æ¡ˆ (Base64)...";
            StateHasChanged();

            // é¦–å…ˆæ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.Size > maxAllowedSize)
            {
                debugInfo = $"æ–‡ä»¶è¿‡å¤§: {GetFileSize(file.Size)}";
                return null;
            }

            using var stream = file.OpenReadStream(maxAllowedSize);
            using var memoryStream = new MemoryStream();

            var buffer = new byte[bufferSize];
            int bytesRead;

            while ((bytesRead = await stream.ReadAsync(buffer)) > 0)
            {
                await memoryStream.WriteAsync(buffer.AsMemory(0, bytesRead));

                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
                if (memoryStream.Length > maxAllowedSize)
                {
                    debugInfo = "è¯»å–è¿‡ç¨‹ä¸­æ–‡ä»¶è¶…è¿‡å¤§å°é™åˆ¶";
                    return null;
                }
            }

            var base64String = Convert.ToBase64String(memoryStream.ToArray());
            var dataUrl = $"data:{file.ContentType};base64,{base64String}";

            debugInfo = "Base64 URLåˆ›å»ºæˆåŠŸ";
            return dataUrl;
        }
        catch (Exception ex)
        {
            debugInfo = $"å¤‡ç”¨æ–¹æ¡ˆå¤±è´¥: {ex.Message}";
            return null;
        }
    }

    /// <summary>
    /// å¼‚æ­¥æ£€æŸ¥éŸ³é¢‘å…ƒç´ çŠ¶æ€
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›éŸ³é¢‘å…ƒç´ çŠ¶æ€</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task CheckAudioState()
    {
        try
        {
            var state = await JSRuntime.InvokeAsync<object>("getAudioElementState", audioElement);
            debugInfo = $"éŸ³é¢‘çŠ¶æ€: {System.Text.Json.JsonSerializer.Serialize(state)}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            debugInfo = $"æ£€æŸ¥éŸ³é¢‘çŠ¶æ€å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }
    /// <summary>
    /// å¼‚æ­¥é‡æ–°åŠ è½½éŸ³é¢‘
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›éŸ³é¢‘å…ƒç´ çŠ¶æ€</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    private async Task ReloadAudio()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("reloadAudio", audioElement);
            debugInfo = "éŸ³é¢‘é‡æ–°åŠ è½½ä¸­...";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            debugInfo = $"é‡æ–°åŠ è½½å¤±è´¥: {ex.Message}";
            StateHasChanged();
        }
    }
    /// <summary>
    /// å¼‚æ­¥å¤„ç½®å¯¹è±¡URL
    /// </summary>
    /// <returns>ä»»åŠ¡å®Œæˆæ—¶è¿”å›éŸ³é¢‘å…ƒç´ çŠ¶æ€</returns>
    /// <exception cref="InvalidOperationException">å½“è¿æ¥æ–­å¼€æ—¶æŠ›å‡º</exception>
    /// <exception cref="Exception">å…¶ä»–å¼‚å¸¸æ—¶æŠ›å‡º</exception>
    public async ValueTask DisposeAsync()
    {
        // æ¸…ç†å¯¹è±¡URL
        if (!string.IsNullOrEmpty(localAudioUrl))
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("URL.revokeObjectURL", localAudioUrl);
                debugInfo = "å¯¹è±¡URLå·²æ¸…ç†";
            }
            catch (Exception ex)
            {
                debugInfo = $"æ¸…ç†å¯¹è±¡URLæ—¶å‡ºé”™: {ex.Message}";
            }
        }
    }
}